---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import FormattedDate from '../../../components/FormattedDate.astro';
import ReadingTime from '../../../components/ReadingTime.astro';
import { slugifyTag } from '../../../utils/slug';

export async function getStaticPaths() {
	const posts = await getCollection('posts');
	const englishPosts = posts.filter((post) => post.data.lang === 'en' && !post.data.draft);
	const spanishTags = new Set<string>();

	posts
		.filter((post) => post.data.lang === 'es' && !post.data.draft)
		.forEach((post) => post.data.tags?.forEach((tag) => spanishTags.add(slugifyTag(tag))));

	const tagMap = new Map<
		string,
		{
			label: string;
			posts: typeof englishPosts;
			hasSpanish: boolean;
		}
	>();

	englishPosts.forEach((post) => {
		post.data.tags?.forEach((tag) => {
			const slug = slugifyTag(tag);
			if (!tagMap.has(slug)) {
				tagMap.set(slug, {
					label: tag,
					posts: [],
					hasSpanish: spanishTags.has(slug),
				});
			}
			tagMap.get(slug)?.posts.push(post);
		});
	});

	return Array.from(tagMap.entries()).map(([slug, info]) => ({
		params: { tag: slug },
		props: {
			posts: info.posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
			tag: info.label,
			tagSlug: slug,
			hasSpanishVersion: info.hasSpanish,
		},
	}));
}

const { posts, tag, tagSlug, hasSpanishVersion } = Astro.props;
const title = `Posts tagged with "${tag}"`;
const description = `Browse all posts tagged with ${tag}.`;
const languageLinks = [
	{ lang: 'en', href: `/tags/${tagSlug}/`, label: 'EN', available: true, isTranslation: true },
	{
		lang: 'es',
		href: hasSpanishVersion ? `/es/tags/${tagSlug}/` : '/es/tags/',
		label: 'ES',
		available: hasSpanishVersion,
		isTranslation: hasSpanishVersion,
		description: hasSpanishVersion ? 'Ver etiquetas equivalentes en español' : 'Explora las etiquetas en español',
	},
];
---

<BaseLayout title={title} description={description} lang="en" languageLinks={languageLinks} canonicalUrl={`/tags/${tagSlug}/`}>
	<div class="bg-white dark:bg-gray-900 py-24 sm:py-32">
		<div class="mx-auto max-w-7xl px-6 lg:px-8">
			<div class="mx-auto max-w-2xl text-center mb-16">
				<div class="mb-4">
					<a
						href="/tags/"
						class="text-sm text-gamboge-600 dark:text-gamboge-400 hover:underline"
					>
						← All tags
					</a>
				</div>
				<h1 class="text-4xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-5xl mb-4">
					<span class="inline-flex items-center px-4 py-2 rounded-full text-3xl sm:text-4xl font-bold bg-gamboge-100 text-gamboge-800 dark:bg-gamboge-900 dark:text-gamboge-200">
						#{tag}
					</span>
				</h1>
				<p class="mt-6 text-lg leading-8 text-gray-600 dark:text-gray-300">
					{posts.length} {posts.length === 1 ? 'post' : 'posts'}
				</p>
			</div>

			<div class="mx-auto max-w-4xl">
				<div class="space-y-12">
						{posts.map((post) => {
							const postUrl = `/posts/${post.slug}/`;
							return (
							<article class="group relative">
								<div class="relative flex flex-col gap-8 lg:flex-row">
									{post.data.heroImage && (
										<div class="lg:w-64 lg:flex-shrink-0">
											<a href={postUrl} class="block">
												<img
													src={post.data.heroImage}
													alt={post.data.heroAlt || post.data.title}
													class="aspect-[16/9] w-full rounded-2xl bg-gray-100 object-cover lg:aspect-[4/3] transition-transform group-hover:scale-105"
													loading="lazy"
												/>
											</a>
										</div>
									)}

									<div class="flex-1">
										<div class="flex items-center gap-x-4 text-xs mb-2">
											<FormattedDate date={post.data.pubDate} lang="en" />
											<span class="text-gray-400">•</span>
											<ReadingTime content={post.body} lang="en" />
										</div>

										<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-3 group-hover:text-gamboge-600 dark:group-hover:text-gamboge-400 transition-colors">
											<a href={postUrl} class="hover:underline">
												{post.data.title}
											</a>
										</h2>

										<p class="text-base leading-7 text-gray-600 dark:text-gray-300 mb-4">
											{post.data.description}
										</p>

										{post.data.tags && post.data.tags.length > 0 && (
											<div class="flex flex-wrap gap-2">
												{post.data.tags.map((postTag) => {
													const postTagSlug = slugifyTag(postTag);
													return (
														<a
															href={`/tags/${postTagSlug}/`}
															class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium transition-colors ${
																postTag === tag
																	? 'bg-gamboge-200 text-gamboge-900 dark:bg-gamboge-800 dark:text-gamboge-100'
																	: 'bg-gamboge-100 text-gamboge-800 hover:bg-gamboge-200 dark:bg-gamboge-900 dark:text-gamboge-200 dark:hover:bg-gamboge-800'
															}`}
														>
															#{postTag}
														</a>
													);
												})}
											</div>
										)}
									</div>
								</div>
							</article>
						);
					})}
				</div>
			</div>
		</div>
	</div>
</BaseLayout>
